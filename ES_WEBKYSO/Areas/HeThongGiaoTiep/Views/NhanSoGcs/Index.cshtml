@{
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
    ViewBag.Title = "Nhận sổ từ CMIS";
}
<div class="container" style="min-height: 851px;">
    <div class="row">
        <div class="col-sm-12">
            <div class="page-header">
                <h3>@*<span class="page-header-text">@ViewBag.Title</span>*@</h3>
                <h3><span style="color: teal">@ViewBag.Title</span></h3>
            </div>
        </div>
    </div>
    <div class="panel panel-success">
        <div class="panel-heading">
            Tìm kiếm
            <i class="fa fa-search text-right"></i>
        </div>
        <div class="panel-body">
            <div class="row">
                <div class="col-md-12">
                    <fieldset>
                        <div class="col-md-12">
                            <div class="row">
                                <div class="form-group">
                                    <div class="col-md-2">
                                        <label class="control-label">
                                            Mã đơn vị
                                        </label>
                                        <input class="form-control" placeholder="Mã đơn vị" type="text" id="MaDonVi" name="MaDonVi" value="@Html.Raw(ViewBag.MaDviQly)" disabled="">
                                    </div>
                                    @*<div class="col-md-6">
                                        <label class="control-label">
                                            Ngày ghi
                                        </label>
                                        <select name="NgayGhi" id="NgayGhi" class="form-control" required>
                                            <option value="">--- Chọn ngày ---</option>
                                            <option value="01">1</option>
                                            <option value="02">2</option>
                                            <option value="03">3</option>
                                            <option value="04">4</option>
                                            <option value="05">5</option>
                                            <option value="06">6</option>
                                            <option value="07">7</option>
                                            <option value="08">8</option>
                                            <option value="09">9</option>
                                            <option value="10">10</option>
                                            <option value="11">11</option>
                                            <option value="12">12</option>
                                            <option value="13">13</option>
                                            <option value="14">14</option>
                                            <option value="15">15</option>
                                            <option value="16">16</option>
                                            <option value="17">17</option>
                                            <option value="18">18</option>
                                            <option value="19">19</option>
                                            <option value="20">20</option>
                                            <option value="21">21</option>
                                            <option value="22">22</option>
                                            <option value="23">23</option>
                                            <option value="24">24</option>
                                            <option value="25">25</option>
                                            <option value="26">26</option>
                                            <option value="27">27</option>
                                            <option value="28">28</option>
                                            <option value="29">29</option>
                                            <option value="30">30</option>
                                            <option value="31">31</option>
                                        </select>
                                    </div>*@
                                    <div class="col-md-2">
                                        <label class="control-label">
                                            Mã sổ
                                        </label>
                                        <input class="form-control" placeholder="Mã sổ" type="text" id="MaSo" name="MaSo">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="control-label">
                                            Tên sổ
                                        </label>
                                        <input class="form-control" placeholder="Tên sổ" type="text" id="TenSo" name="TenSo">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="control-label">
                                            Ngày ghi
                                        </label>
                                        <select name="NgayGhi" id="NgayGhi" class="form-control" required>
                                            <option value="" selected="">--- Chọn ngày ---</option>
                                            <option value="01">1</option>
                                            <option value="02">2</option>
                                            <option value="03">3</option>
                                            <option value="04">4</option>
                                            <option value="05">5</option>
                                            <option value="06">6</option>
                                            <option value="07">7</option>
                                            <option value="08">8</option>
                                            <option value="09">9</option>
                                            <option value="10">10</option>
                                            <option value="11">11</option>
                                            <option value="12">12</option>
                                            <option value="13">13</option>
                                            <option value="14">14</option>
                                            <option value="15">15</option>
                                            <option value="16">16</option>
                                            <option value="17">17</option>
                                            <option value="18">18</option>
                                            <option value="19">19</option>
                                            <option value="20">20</option>
                                            <option value="21">21</option>
                                            <option value="22">22</option>
                                            <option value="23">23</option>
                                            <option value="24">24</option>
                                            <option value="25">25</option>
                                            <option value="26">26</option>
                                            <option value="27">27</option>
                                            <option value="28">28</option>
                                            <option value="29">29</option>
                                            <option value="30">30</option>
                                            <option value="31">31</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="control-label">
                                            Trạng thái
                                        </label>
                                        <select id="TrangThai" name="TrangThai" class="form-control">
                                            @*<option value="">---Chọn trạng thái---</option>*@
                                            <option value="DL">Đã lấy</option>
                                            <option value="CL" selected="">Chưa lấy</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <br />
                                        <button type="submit" class="btn btn-primary" value="Lấy dữ liệu CMIS" id="btnGetData">
                                            <i class="fa fa-search"></i>
                                            Tìm kiếm
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        @*<div class="col-md-6">
                            <div class="row">
                                <div class="form-group">

                                    <div class="col-md-5">
                                        <label class="control-label">
                                            Hình thức GCS
                                        </label>
                                        <select id="HinhThuc" name="HinhThuc" class="form-control">
                                            <option value="">---Chọn hình thức---</option>
                                            <option value="MTB">MTB</option>
                                            <option value="HHU">HHU</option>
                                            <option value="MDMS">MDMS</option>
                                        </select>
                                    </div>
                                    
                                </div>
                            </div>
                            <br />
                            
                        </div>*@
                        
                    </fieldset>

                </div>
            </div>
            @*<div><font color="red">(*) Tiêu chí tìm kiếm</font></div>*@

        </div>
    </div>
    <div class="panel panel-success">
        <div class="panel-heading">
            Thao tác
            <i class="fa fa-pencil-square-o text-right"></i>
        </div>
        <div class="panel-body">
            <fieldset>
                <div class="col-md-12">
                    <div class="row">
                        <div class="form-group">
                            <div class="col-md-3">
                                <label class="control-label">
                                    Kỳ GCS
                                </label>
                                <select name="Ky" id="Ky" class="form-control" value="1" required>
                                    <option value="01" selected="">1</option>
                                    <option value="02">2</option>
                                    <option value="03">3</option>
                                    <option value="04">4</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="control-label">
                                    Tháng
                                </label>
                                <select name="Thang" id="Thang" class="form-control" required>
                                    <option value="01">1</option>
                                    <option value="02">2</option>
                                    <option value="03">3</option>
                                    <option value="04">4</option>
                                    <option value="05">5</option>
                                    <option value="06">6</option>
                                    <option value="07">7</option>
                                    <option value="08">8</option>
                                    <option value="09">9</option>
                                    <option value="10">10</option>
                                    <option value="11">11</option>
                                    <option value="12">12</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="control-label">
                                    Năm
                                </label>
                                <input type="text" placeholder="Năm" id="Nam" name="Nam" class="form-control" required>
                            </div>
                            &nbsp;
                            <br />
                            <div class="col-md-2">
                                <button type="submit" class="btn btn-primary" value="Lấy dữ liệu CMIS" id="btnGetCMIS" name="btnGetCMIS">
                                    <i class="fa fa-arrow-down"></i>
                                    Lấy dữ liệu CMIS
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </fieldset>
        </div>
    </div>
    <br />
    <div class="row">
        <div class="col-md-12">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <i class="fa fa-file-text"></i>
                    @ViewBag.Title
                </div>
                <div class="panel-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered table-hover table-full-width" id="TableGeneric">
                            <thead></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section PageScripts{
    @*<script src="~/Scripts/jquery.validate.new.js"></script>*@
    <script src="~/Scripts/jquery.validate.js"></script>
    <script src="~/Scripts/jquery.validate.unobtrusive.js"></script>
    @Scripts.Render("~/js/datatables")
    <script src="~/Content/themes/ClipOne/plugins/DataTables/media/js/jquery.dataTables.editable.js"></script>

    <script type="text/javascript">
        (function ($) {
            "use strict";
            $(function () {
                var temp = "01";
                var d = new Date();
                $("#Ky").val(temp);
                $("#Nam").val(d.getFullYear());
            });
            $(function () {
                var d = new Date();
                var m = d.getMonth();
                $('#Thang option:eq(' + m + ')').prop('selected', true);
            });

            window.TableConfig = [];
            window.TableConfig[0] = {
                id: "TableGeneric",
                url: "@Url.Action("GetJson")", 
                //funcgr: function (grid) {
                //    window.TableGenericNhanSoGcsGrid = grid;
                //},
                reloadFunc: function (d) {
                    d.MaDonVi = $("#MaDonVi").val();
                    d.Thang = $("#Thang").val();
                    d.Nam = $("#Nam").val();
                    d.NgayGhi = $("#NgayGhi").val();
                    d.MaSo = $("#MaSo").val();
                    d.TenSo = $("#TenSo").val();
                    d.LoaiSo = $("#LoaiSo").val();
                    d.MaDoi = $("#MaDoi").val();
                    d.HinhThuc = $("#HinhThuc").val();
                    d.TrangThai = $("#TrangThai").val();
                    d.maDvQly = $("#MaDonVi").val();
                                    
                },
                AddOn: {
                    "columnDefs": [
                        {
                            "targets": -1,
                            "data": null,
                            "render": function (data, type, full) {
                                //if (data.STATUS == "DPC" || data.STATUS == "DTH") {
                                if (data.TRANG_THAI == "DL") {
                                    var ret = '<div><a class="btn btn-xs btn-bricky tooltips Delete" data-id="ID_SOGCSParameter" href="#"><i class="fa fa-trash-o"></i> Hủy</a></div>';
                                    ret = ret.replace(/ID_SOGCSParameter/g, data.ID_SOGCS);
                                    return ret;
                                }
                                else {
                                    var ret = '<div></div>';
                                    return ret;
                                }
                                //}
                                //else {
                                //    var ret = '<div></div>';
                                //    return ret;
                                //}
                            }
                        }
                    ]
                },
                columns: [
                    {
                        data: null,
                        type: 'checkbox',
                        className: 'dt-center center',
                        'bSortable': false,
                        render: function (data) {
                            return '<div class="checkbox-table"><label><input type="checkbox" name="chkSo" class="checkboxes" id="chkSo" value="' + data.ID_SOGCS + '"/></label></div>';
                        }
                    },
                    {
                        header: "Mã sổ",
                        data: "MA_SOGCS"
                    },
                    {
                        header: "Tên sổ",
                        data: "TEN_SOGCS"
                    },
                     //{
                     //    header: "Hình thức ghi",
                     //    data: "HINH_THUC"
                     //},
                    {
                        header: "Ngày ghi",
                        data: "NGAY_GHI"
                    },
                    {
                        header: "Trạng thái",
                        data: "TRANG_THAI",
                        render: function (data) {
                            if (data === "DL") {
                                return "<div class='label label-sm label-success'>Đã lấy</div>";
                            } else {
                                return "<div class='label label-sm label-info'>Chưa lấy</div>";
                            }
                        }
                    },
                    {
                        'bSortable': false,
                        header: "Tác vụ",
                        className: "center",
                        data: null
                    }
                ],
                func: function (grid) {
                    $("#TableGeneric")
                        .on('click',
                            '.Delete',
                            function () {
                                //e.preventDefault();

                                var thisTrData = $(this).attr('data-id');


                                //if (confirm("Bạn có chắc chắn muốn hủy nhận sổ?")) {
                                    $.ajax({
                                        type: 'POST',
                                        cache: false,
                                        async: true,
                                        url: "@Html.Raw(Url.Action("Delete"))",
                                        dataType: 'json',
                                        data: JSON.stringify({ ID_SOGCS: thisTrData }),
                                        contentType: "application/json; charset=utf-8",
                                        success: function (result) {
                                            if (result.success == true) {
                                                alert(result.message);
                                                document.getElementById("btnGetData").click();
                                            }
                                        },
                                        error: function (jqXHR, textStatus, errorThrown) {

                                        },
                                        complete: function (result) {
                                            //grid.ajax.reload();
                                            document.getElementById("btnGetData").click();
                                        }
                                    });
                                //}

                            });
                },

                //funcOnDraw: function () {
                //},
            };
            //$(function () {
            //    var d = new Date();
            //    var m = d.getDate();
            //    $('#NgayGhi option:eq(' + m + ')').prop('selected', true);
            //});
            $("#btnGetData").on('click',
               function () {
                   AutoDataTable();
               });
            //$('#btnGetCMIS').click(function () {

            //    var dataToPost = {};
            //    dataToPost.MaDonVi = $("#MaDonVi").val();
            //    dataToPost.Ky = $("#Ky").val();
            //    dataToPost.Thang = $("#Thang").val();
            //    dataToPost.Nam = $("#Nam").val();
            //    dataToPost.MaSo = $("#MaSo").val();
            //    dataToPost.LoaiSo = $("#LoaiSo").val();
            //    dataToPost.NgayGhi = $("#NgayGhi").val();
            //    dataToPost.search = $("#TableGeneric_wrapper").find("[type='search']").val();
            //    dataToPost.maDvQly = $("#MaDonVi").val();
            //    dataToPost.TrangThai = $("#TrangThai").val();

            //    $.ajax({
            //        contentType: 'application/json; charset=utf-8',
            //        type: "POST",
            //        url: "/NhanSoGcs/JsonLayDuLieuCmis",
            //        dataType: 'json',
            //        data: JSON.stringify(dataToPost),
            //        traditional: true,
            //        async: true,
            //        processData: false,
            //        cache: false,
            //        success: function (result) {
            //            if (result.success === false) {
            //                alert(result.message);
            //                window.TableGenericGrid.ajax.reload();
            //            } else {
            //                alert(result.message);
            //            }
            //        },
            //        error: function (xhr, textStatus, errorThrown) {
            //            alert('request failed');
            //        }
            //    });
            //});

            $("#btnGetCMIS").on('click',
               function () {
                   if (getCheckedId() == "") {

                       alert('Mời chọn sổ GCS'); return
                   };
                   debugger;
                   $.ajax({
                       type: 'POST',
                       url: '@Url.Action("JsonLayDuLieuCmis")',
                       dataType: 'json',
                       traditional: true,
                       data: {
                           ids: getCheckedId(),
                           MaDonVi: $("#MaDonVi").val(),
                           Ky: $("#Ky").val(),
                           Thang: $("#Thang").val(),
                           Nam: $("#Nam").val()
                       },
                       //success: function (result) {
                       //    if (result.success === false) {
                       //        alert(result.message);
                       //        document.getElementById("btnGetData").click();
                       //    } else {
                       //        alert(result.message);
                       //    }
                       //},
                       success:
                           function (data) {
                               if (data.success == true) {
                                   alert(data.message)
                                   //if (data.Data != null) alert(data.Data);
                                   document.getElementById("btnGetData").click();
                               }
                               else {
                                   alert(data.message)
                               }
                           },
                       error: function (ex) {
                           alert('Có lỗi xảy ra trong quá trình nhận sổ: ' + ex);
                       }
                   });
               });
            function getCheckedId() {
                var checkboxes = document.getElementsByName('chkSo');
                var listIDs = new Array();
                for (var i = 0, n = checkboxes.length; i < n; i++) {
                    if (checkboxes[i].checked) {
                        listIDs.push(checkboxes[i].value);
                    }
                }
                return listIDs;
            }
        })(jQuery);
    </script>
}