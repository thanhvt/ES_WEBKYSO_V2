@model ES_WEBKYSO.Models.GCS_LICHGCS
@{
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
    ViewBag.Title = "Nhân viên GCS ký bảng kê";
}
<script src="~/Scripts/jquery-1.11.2.min.js"></script>

<div class="container" style="min-height: 851px;">
    <div class="row">
        <div class="col-sm-12">
            <div class="page-header">
                <h3>@*<span class="page-header-text">@ViewBag.Title</span>*@</h3>
                <h3><span style="color: teal">Nhân viên GCS ký bảng kê</span></h3>
            </div>
        </div>
    </div>

    <div class="panel panel-success">
        <div class="panel-heading">
            Tìm kiếm
            <i class="fa fa-search text-right"></i>
        </div>
        <div class="panel-body">
            <div class="row">
                <div class="col-md-12">
                    <fieldset>
                        <div class="col-md-12">
                            <div class="row">
                                <div class="form-group">
                                    <div class="col-md-2">
                                        <label class="control-label">
                                            Mã đơn vị
                                        </label>
                                        <input class="form-control" placeholder="Mã đơn vị" type="text" id="MaDonVi" name="MaDonVi" value="@Html.Raw(ViewBag.MaDviQly)" disabled="">
                                    </div>
                                    <div class="col-md-1">
                                        <label class="control-label">
                                            Ngày ghi
                                        </label>
                                        <input type="text" class="form-control input-append date" id="NgayGhi" name="NgayGhi" data-date="01" data-date-format="dd">
                                        @*<select name="NgayGhi" id="NgayGhi" class="form-control" required>
                                                <option value="">--- Chọn ngày ---</option>
                                                <option value="01">1</option>
                                                <option value="02">2</option>
                                                <option value="03">3</option>
                                                <option value="04">4</option>
                                                <option value="05">5</option>
                                                <option value="06">6</option>
                                                <option value="07">7</option>
                                                <option value="08">8</option>
                                                <option value="09">9</option>
                                                <option value="10">10</option>
                                                <option value="11">11</option>
                                                <option value="12">12</option>
                                                <option value="13">13</option>
                                                <option value="14">14</option>
                                                <option value="15">15</option>
                                                <option value="16">16</option>
                                                <option value="17">17</option>
                                                <option value="18">18</option>
                                                <option value="19">19</option>
                                                <option value="20">20</option>
                                                <option value="21">21</option>
                                                <option value="22">22</option>
                                                <option value="23">23</option>
                                                <option value="24">24</option>
                                                <option value="25">25</option>
                                                <option value="26">26</option>
                                                <option value="27">27</option>
                                                <option value="28">28</option>
                                                <option value="29">29</option>
                                                <option value="30">30</option>
                                                <option value="31">31</option>
                                            </select>*@
                                    </div>
                                    <div class="col-md-2">
                                        <label class="control-label">
                                            Mã sổ
                                        </label>
                                        <input class="form-control" placeholder="Mã sổ" type="text" id="MaSo" name="MaSo">
                                    </div>


                                    <div class="col-md-1">
                                        <label class="control-label">
                                            Kỳ GCS
                                        </label>
                                        <select name="Ky" id="Ky" class="form-control" required>
                                            <option value="">--- Chọn kỳ ---</option>
                                            <option value="01">1</option>
                                            <option value="02">2</option>
                                            <option value="03">3</option>
                                            <option value="04">4</option>
                                        </select>
                                    </div>
                                    <div class="col-md-1">
                                        <label class="control-label">
                                            Tháng
                                        </label>
                                        @*<input type="text" class="form-control input-append date" id="Thang" name="Thang" data-date="01" data-date-format="MM">*@
                                        <select name="Thang" id="Thang" class="form-control" required>
                                            <option value="">--- Chọn tháng ---</option>
                                            <option value="01">1</option>
                                            <option value="02">2</option>
                                            <option value="03">3</option>
                                            <option value="04">4</option>
                                            <option value="05">5</option>
                                            <option value="06">6</option>
                                            <option value="07">7</option>
                                            <option value="08">8</option>
                                            <option value="09">9</option>
                                            <option value="10">10</option>
                                            <option value="11">11</option>
                                            <option value="12">12</option>
                                        </select>
                                    </div>
                                    <div class="col-md-1">
                                        <label class="control-label">
                                            Năm
                                        </label>
                                        <input type="text" class="form-control input-append date" id="Nam" name="Nam" data-date="02-2012" data-date-format="yyyy">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="control-label">
                                            Trạng thái
                                        </label>
                                        <select id="TrangThaiKy" name="TrangThaiKy" class="form-control">
                                            <option value="">--- Chọn trạng thái ---</option>
                                            <option value="true">Đã ký</option>
                                            <option value="false" selected>Chưa ký</option>
                                        </select>
                                    </div>
                                    <div class="col-md-1">
                                        <br />
                                        <button type="submit" class="btn btn-primary" value="Tìm kiếm" id="btnGetData">
                                            <i class="fa fa-search"></i>
                                            Tìm kiếm
                                        </button>
                                    </div>
                                    @*<div class="col-md-6">
                                            <label class="control-label">
                                                Loại sổ
                                            </label>
                                            <select id="LoaiSo" name="LoaiSo" class="form-control" onclick="disable(value);">
                                                <option value="">--- Chọn loại sổ ---</option>
                                                <option value="KH">KH</option>
                                                <option value="DN">DN</option>
                                            </select>
                                        </div>*@
                                    @*<div class="col-md-6">*@
                                    @*<label class="control-label">
                                            Loại bảng kê
                                        </label>
                                        <select name="MaLoaiBangKeSearch" id="MaLoaiBangKeSearch" class="form-control" required>
                                            <option value="">--- Loại bảng kê ---</option>
                                        </select>*@
                                    @*</div>*@
                                </div>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <div class="row">
                                <div class="col-md-3">
                                    @*<label class="control-label">
                                            Tổ đội
                                        </label>
                                        <select name="MaDoi" id="MaDoi" class="form-control" required>
                                            <option value="">--- Chọn tổ đội ---</option>
                                        </select>*@
                                    @*@Html.EditorFor(x => x.MA_DOIGCS, new { dropKey = "MA_DOIGCS", label = "--- Chọn tổ đội ---", htmlAttributes = new { @class = "form-control", style = "width:253px; margin-left:-15px;" } })*@
                                </div>



                                @*<div class="col-md-1">
                                    <br />
                                    <button type="submit" class="btn btn-primary" value="Tìm kiếm" id="btnGetData">
                                        <i class="fa fa-search"></i>
                                        Tìm kiếm
                                    </button>
                                </div>*@
                            </div>
                        </div>


                    </fieldset>

                </div>
            </div>
        </div>
    </div>

    <div class="panel panel-success">
        <div class="panel-heading">
            Thao tác
            <i class="fa fa-pencil-square-o text-right"></i>
        </div>
        <div class="panel-body">
            <fieldset>
                <div class="col-md-11">
                    <div class="row">
                        <div class="form-group">
                            <div class="col-md-3">
                                @*@Html.EditorFor(x => x.MA_DOIGCS, new { dropKey = "MA_LOAIBANGKE", label = "--- Chọn loại bảng kê ---", htmlAttributes = new { @class = "form-control", style = "width:253px; margin-left:-15px;" } })*@
                                @*@Html.DropDownList("MA_LOAIBANGKE", ViewBag.MA_LOAIBANGKE as SelectList)*@
                                <select name="MaLoaiBangKe" id="MaLoaiBangKe" class="form-control" required>
                                    <option value="">--- Chọn loại bảng kê ---</option>
                                </select>
                            </div>
                            <div class="col-sm-6">
                                @*<button type="submit" class="btn btn-primary" value="Xem bảng kê" id="btnXemBangKe">
                                        <i class="fa fa-eye"></i>
                                        Xem bảng kê
                                    </button>
                                    &nbsp;*@
                                <button type="submit" class="btn btn-primary" id="btnKyBangke">
                                    <i class="fa fa-check"></i>
                                    Ký bảng kê
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <br />

            </fieldset>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <i class="fa fa-file-text"></i>
                    @ViewBag.Title
                </div>
                <div class="panel-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered table-hover table-full-width" id="TableGeneric">
                            <thead></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-sm-10" align="left">
        </div>
    </div>
</div>
<div id="full-width" class="modal container fade in" tabindex="-1" style="display: none; margin-top: -138.5px;" aria-hidden="false">
    <div class="modal-body">
        @Html.Partial("~/Views/ReportBangKeChiSo.aspx")
    </div>
</div>
<a id="aSign" class="hidden essign_btnSign" href="javascript:void(0);">Sign</a>
@section PageScripts{
    @*<script src="~/Scripts/jquery.validate.new.js"></script>*@
    <script src="~/Scripts/jquery.validate.js"></script>
    <script src="~/Scripts/jquery.validate.unobtrusive.js"></script>
    @Scripts.Render("~/js/datatables")
    <script src="~/Content/themes/ClipOne/plugins/DataTables/media/js/jquery.dataTables.editable.js"></script>

    <script type="text/javascript">
        //$("#Nam").datepicker({
        //    viewMode: 'years',
        //    format: 'yyyy'
        //});
        //$("#Thang").datepicker({
        //    viewMode: 'month',
        //    format: 'mm'
        //});
        $("#TrangThaiKy").change(function () {
            $("#MaLoaiBangKe").attr("disabled", this.value === "true");
            $("#btnKyBangke").attr("disabled", this.value == "true");
        });

        $("#MaLoaiBangKe").change(function () {
            $("#btnKyBangke").attr("disabled", this.value == "");
        });

        $("#NgayGhi").datepicker({
            viewMode: 'day',
            format: 'dd'
        });

      

        $(document).ready(function () {
            $.ajax({ //lấy danh sách đội cho phần thao tác
                type: 'POST',
                url: '@Url.Action("GetDOI_GCS")',
                dataType: 'json',
                traditional: true,
                data: {},
                success:
                    function (tous) {
                        $.each(tous, function (i, tou) {
                            $("#MaDoi").append('<option value="' + tou.MAChar + '">' + tou.TEN + '</option>');
                        });
                    },
                error: function (ex) {
                    alert('Có lỗi xảy ra trong quá trình tải dữ liệu: ' + ex);
                }
            });
            return false;
        });
        $(document).ready(function () {
            $.ajax({
                type: 'POST',
                url: '@Url.Action("GetLoaiBangKe")',
                dataType: 'json',
                traditional: true,
                data: { },
                success:
                    function (tous) {
                        $.each(tous, function (i, tou) {
                            $("#MaLoaiBangKe").append('<option value="' + tou.MAChar + '">' + tou.TEN + '</option>');
                        });
                        //$("#MaLoaiBangKe option[value='BKCS']").attr("selected", "selected");
                        //$("#MaLoaiBangKe option[value=BKCS]").prop("selected", true);
                        //$("#MaLoaiBangKe").select2().select2('val', 'BKCS');
                        //$("#MaLoaiBangKe").val('BKCS');
                       
                    },
                error: function (ex) {
                    alert('Có lỗi xảy ra trong quá trình tải dữ liệu: ' + ex);
                }
            });
            //$("#MaLoaiBangKe option[value='BKCS']").attr("selected", true);
            return false;
        });
        var search = "BKCS";
        $('#MaLoaiBangKe option:contains(' + search + ')').prop('selected', true);
        (function ($) {
            "use strict";
            window.TableConfig = [];

            window.TableConfig[0] = {
                id: "TableGeneric",
                url: "@Url.Action("GetJson")",
                //funcgr: function (grid) {
                //    window.TableGenericCapNhatChiSoGrid = grid;
                //},
                reloadFunc: function (d) {
                    d.MaDonVi = $("#MaDonVi").val();
                    d.NgayGhi = $("#NgayGhi").val();
                    d.MaSo = $("#MaSo").val();
                    d.LoaiSo = $("#LoaiSo").val();
                    d.Ky = $("#Ky").val();
                    d.Thang = $("#Thang").val();
                    d.Nam = $("#Nam").val();
                    //d.TrangThai = $("#TrangThai").val();
                    d.Gio = $("#Gio").val();
                    @*d.MaDoi = '@Request["MA_DOIGCS"]';*@
                    d.MaDoi = $("#MaDoi").val();
                    d.MaLoaiBangKe = $("#MaLoaiBangKeSearch").val();
                    d.TrangThaiKy = $("#TrangThaiKy").val();

                    console.log(d);
                },
                AddOn: {
                    "columnDefs": [
                        {
                            "targets": -1,
                            "data": null,
                            "render": function (data, type, full) {
                                var ret = "";
                                if (data.TrangThaiKy == true) {
                                    ret =
                                        '<div><a class="btn btn-xs btn-teal tooltips Edit" href="@ViewBag.Link" target="_blank""><i class="fa fa-eye"></i></a></div>';
                                } else {
                                    ret = '<div><button class="btn btn-xs btn-teal tooltips Edit" onclick=getReport("IdLich","MaBangKe")><i class="fa fa-eye"></i></button></div>';
                                }

                                @*var ret =
                                    '<div><a class="btn btn-xs btn-teal tooltips Edit" data-toggle="modal" data-target="#popupStaticModal" href="@Url.Action("ViewBangKe", "NhanVienKyBangKe", new {ID_LICHGCS = "ID_LICHGCSParameter"})"><i class="fa fa-eye"></i></a> ' + '<a class="btn btn-xs btn-teal tooltips Edit" href="@Url.Action("BangKeVieweResult", "NhanVienKyBangKe", new {ID_LICHGCS = "ID_LICHGCSParameter"})"><i class="fa fa-edit"></i></a></div>';*@
                                ret = ret.replace("IdLich", data.ID_LICHGCS).replace("MaBangKe", data.MA_LOAIBANGKE);
                                return ret;
                            }
                        }
                    ]
                },
                columns: [
                    {
                        data: null,
                        type: 'checkbox',
                        className: 'dt-center center',
                        'bSortable': false,
                        render: function (data) {
                            return '<div class="checkbox-table"><label><input type="checkbox" name="chkSo" id="chkSo" class="checkboxes" value="' + data.ID_LICHGCS + '"/></label></div>';
                        }
                    },
                    {
                        header: "Mã sổ",
                        data: "MA_SOGCS"
                    },
                    {
                        header: "Tên sổ",
                        data: "TEN_SOGCS"
                    },
                    {
                        header: "Hình thức ghi",
                        data: "HINH_THUC"
                    },
                    {
                        header: "Ngày ghi",
                        data: "NGAY_GHI"
                    },
                    {
                        header: "Kỳ",
                        data: "KY"
                    },
                    {
                        header: "Tháng",
                        data: "THANG"
                    },
                    {
                        header: "Năm",
                        data: "NAM"
                    },
                    {
                        header: "Tổ đội",
                        data: "MA_DOIGCS"
                    }, {
                        header: "Nhân viên GCS",
                        data: "FullName"
                    },
                    {
                        header: "Loại bảng kê",
                        data: "MA_LOAIBANGKE"
                    },
                    {
                        header: "Trạng thái",
                        data: "TrangThaiKy",
                        render: function (data) {
                            if (data == true) {
                                return "<div class='label label-sm label-success'>Đã ký</div>";
                            } else {
                                return "<div class='label label-sm label-info'>Chưa ký</div>";
                            }
                        }
                    },
                    {
                        'bSortable': false,
                        header: "Tác vụ",
                        className: "center",
                        data: null
                    }
                ]
            };

            $(function () {
                var temp = "01";
                var gio = "0";
                var thang = "01";
                var d = new Date();
                $("#Ky").val(temp);
                $("#Gio").val(gio);
                $("#Thang").val(d.getMonth() + 1);
                $("#Nam").val(d.getFullYear());
            });
            $(function () {
                var d = new Date();
                var m = d.getMonth() + 1;
                $('#Thang option:eq(' + m + ')').prop('selected', true);
            });
            //$(function () {
            //    var d = new Date();
            //    var m = d.getDate();
            //    $('#NgayGhi option:eq(' + m + ')').prop('selected', true);
            //});
            $("#btnGetData").on('click',
                function () {
                    AutoDataTable();
                });

            $('#MaSoGcsParameter').click(function () {

                var dataToPost = {};
                dataToPost.MaDonVi = $("#MaDonVi").val();
                dataToPost.Thang = $("#Thang").val();
                dataToPost.Ky = $("#Ky").val();
                dataToPost.Thang = $("#Thang").val();
                dataToPost.Nam = $("#Nam").val();
                dataToPost.MaSo = $("#MaSo").val();
                dataToPost.NgayGhi = $("#NgayGhi").val();
                dataToPost.HinhThuc = $("#HinhThuc").val();
                dataToPost.search = $("#TableGeneric_wrapper").find("[type='search']").val();
                dataToPost.maDvQly = $("#MaDonVi").val();
                dataToPost.TrangThaiKy = $("#TrangThaiKy").val();
                dataToPost.Gio = $("#Gio").val();
                dataToPost.MaDoi = '@Request["MA_DOIGCS"]';

                $.ajax({
                    contentType: 'application/json; charset=utf-8',
                    type: "POST",
                    url: "/XemBangKe/NhanVienKyBangKe",
                    dataType: 'json',
                    data: JSON.stringify(dataToPost),
                    traditional: true,
                    async: true,
                    processData: false,
                    cache: false,
                    success: function (result) {
                        if (result.success === true) {
                            alert(result.message);
                            window.TableGenericGrid.ajax.reload();
                        } else {
                            alert(result.message);
                        }
                    },
                    error: function (xhr, textStatus, errorThrown) {
                        alert('request failed');
                    }
                });
            });

            @*$('#btnKyBangke').click(function () {
                var dataToPost = {};
                debugger;
                if (getCheckedId() == "") {
                    alert('Mời chọn sổ GCS');
                    return
                };
                var maLich = 13;
                var maLoaiBk = "TTBT";
                $.ajax({
                    contentType: 'application/json; charset=utf-8',
                    type: "POST",
                    url: '@Url.Action("SignPerform")',
                    dataType: 'json',
                    data: { ids: getCheckedId(), idLichGcs: maLich, maLoaiBangKe: maLoaiBk },
                    traditional: true,
                    async: true,
                    processData: false,
                    cache: false,
                    @*type: 'POST',
                    url: '@Url.Action("SignPerform")',
                    dataType: 'json',
                    traditional: true,
                    success: function(data) {
                        debugger;
                        if (data.Result === true) {
                            alert(data.Message);
                        } else {
                            alert(data.Message);
                        }
                    },
                    error: function(xhr, textStatus, errorThrown) {
                        alert('request failed');
                    }
                });
            });*@
            $("#btnKyBangke").on('click',
                function () {
                    debugger;
                    var dataToPost = {};
                    dataToPost.maLoaiBangKe = $("#MaLoaiBangKe").val();
                    if (getCheckedId() == "") { alert('Vui lòng chọn bản ghi để tiến hành ký!'); return };
                    $.ajax({
                        type: 'POST',
                        url: '@Url.Action("SignPerform")',
                        dataType: 'json',
                        traditional: true,
                        data: { ids: getCheckedId(), maLoaiBangKe: dataToPost.maLoaiBangKe },
                        success: function (data) {
                            if (data.Result == true) {
                                alert(data.Message);
                                var callApp = data.Data.CallApp;
                                var keySign = data.Data.KeySign;
                                var caVersion = data.Data.CAVersion;
                                CallApp(callApp, keySign, caVersion);
                                AutoDataTable();
                            }
                        },
                        error: function (ex) {
                            alert('Có lỗi xảy ra trong quá trình ký: ' + ex);
                        }
                    });
                });

            function getCheckedId() {
                var checkboxes = document.getElementsByName('chkSo');
                var listIDs = new Array();
                for (var i = 0, n = checkboxes.length; i < n; i++) {
                    if (checkboxes[i].checked) {
                        listIDs.push(checkboxes[i].value);
                    }
                }
                return listIDs;
            }
        })(jQuery);
        function getReport(IdLich, MaBangKe) {
            $.ajax({
                type: 'GET',
                url: '@Url.Action("GetReport")',
                dataType: 'json',
                data: { IdLich: IdLich, MaBangKe: MaBangKe }
            });
        }
    </script>
}